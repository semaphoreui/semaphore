machine:
  environment:
    CPATH: "/home/ubuntu/.go_workspace/src/github.com/ansible-semaphore/semaphore/"

dependencies:
  pre:
    - sudo rm -rf /usr/local/go
    - sudo curl -L https://storage.googleapis.com/golang/go1.10.linux-amd64.tar.gz > /tmp/go.tar.gz
    - sudo tar -C /usr/local -xzf /tmp/go.tar.gz
    - go get -u -v github.com/go-task/task/cmd/task
    - task deps
  override:
     - mkdir -p $CPATH
     - rsync -azC --delete ./ $CPATH
     - task compile

test:
  pre:
    - | cat > config.json <<EOF
      {
      	"mysql": {
      		"host": "127.0.0.1:3306",
      		"user": "ubuntu",
      		"pass": "",
      		"name": "circle_test"
      	},
      	"session_db": "127.0.0.1:6379",
      	"port": ":8010",
      	"email_alert": false
      }
      EOF
    - cd $CPATH && go run cli/main.go --migrate -config config.json
  override:
    - task test
    - task build
    - task ci:artifacts